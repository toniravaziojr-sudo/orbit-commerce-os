# Integra√ß√µes ‚Äî Regras e Especifica√ß√µes

> **STATUS:** ‚úÖ Ready

## Vis√£o Geral

Hub central de integra√ß√µes com servi√ßos externos: pagamentos, redes sociais, marketplaces, WhatsApp, email, dom√≠nios, ERP.

---

## Arquivos Principais

| Arquivo | Descri√ß√£o |
|---------|-----------|
| `src/pages/Integrations.tsx` | P√°gina principal de integra√ß√µes (tenant) |
| `src/pages/PlatformIntegrations.tsx` | P√°gina de integra√ß√µes (operador) |
| `src/components/integrations/DomainAndEmailSettings.tsx` | Aba unificada Dom√≠nio/Email |
| `src/components/settings/DomainSettingsContent.tsx` | Configura√ß√£o de dom√≠nios da loja |
| `src/components/payments/PaymentGatewaySettings.tsx` | Config de gateways |
| `src/components/integrations/WhatsAppProviderTabs.tsx` | Config WhatsApp |
| `src/components/integrations/MarketplacesIntegrationTab.tsx` | Marketplaces |
| `src/components/integrations/MetaConnectionSettings.tsx` | Meta/Facebook |
| `src/components/emails/EmailDnsSettings.tsx` | DNS de email |

---

## Estrutura de Abas (Tenant)

| Tab | Valor | Componente | Descri√ß√£o |
|-----|-------|------------|-----------|
| Pagamentos | `payments` | `PaymentGatewaySettings` | Gateways de pagamento |
| Redes Sociais | `social` | `MetaConnectionSettings`, `LateConnectionSettings` | Meta, Late |
| Marketplaces | `marketplaces` | `MarketplacesIntegrationTab` | Mercado Livre, etc |
| WhatsApp | `whatsapp` | `WhatsAppProviderTabs` | Providers de WhatsApp |
| **Dom√≠nio/Email** | `domain-email` | `DomainAndEmailSettings` | Dom√≠nio da loja + Email |
| Outros | `outros` | Cards ERP | Integra√ß√µes ERP (em breve) |
| Plataforma | `platform` | Sub-tabs operador | Apenas para `isPlatformOperator` |

---

## Aba Dom√≠nio/Email

A aba `domain-email` unifica duas se√ß√µes:

### 1. Dom√≠nio da Loja
- **Componente:** `DomainSettingsContent`
- **Funcionalidades:**
  - URL padr√£o (gr√°tis): `{tenantSlug}.shops.comandocentral.com.br`
  - Dom√≠nios personalizados (custom domains)
  - Verifica√ß√£o DNS (TXT)
  - Provisionamento SSL (Cloudflare Custom Hostnames)
  - Definir dom√≠nio principal
- **Refer√™ncia completa:** `docs/regras/dominios.md`

### 2. Dom√≠nio de Email
- **Componente:** `EmailDnsSettings`
- **Funcionalidades:**
  - Configura√ß√£o de DNS para email (SPF, DKIM, DMARC)
  - Verifica√ß√£o de dom√≠nio de envio
  - Integra√ß√£o com SendGrid

---

## Categorias de Integra√ß√£o

### 1. Pagamentos
| Gateway | Status | Descri√ß√£o |
|---------|--------|-----------|
| Mercado Pago | ‚úÖ Ready | Principal gateway |
| PagSeguro | üüß Pending | Em desenvolvimento |
| Stripe | üüß Pending | Planejado |
| PIX direto | ‚úÖ Ready | Via gateways |

### 2. Redes Sociais
| Plataforma | Status | Descri√ß√£o |
|------------|--------|-----------|
| Meta (FB/IG) | ‚úÖ Ready | Cat√°logo, pixel |
| Instagram | ‚úÖ Ready | Via Meta |
| Late | ‚úÖ Ready | Agendamento de posts |
| TikTok | üüß Pending | Planejado |
| Google | üüß Pending | Merchant Center |

### 3. Marketplaces
| Marketplace | Status | Descri√ß√£o |
|-------------|--------|-----------|
| Mercado Livre | ‚úÖ Ready | Sincroniza√ß√£o de produtos |
| Shopee | ‚úÖ Ready | Sincroniza√ß√£o de pedidos e OAuth |
| Amazon | üüß Pending | Planejado |

### 4. WhatsApp
| Provider | Status | Descri√ß√£o |
|----------|--------|-----------|
| WhatsApp Cloud API | üüß Pending | Oficial Meta |
| Z-API | üüß Pending | N√£o-oficial |
| Evolution API | üüß Pending | Self-hosted |

### 5. Email
| Servi√ßo | Status | Descri√ß√£o |
|---------|--------|-----------|
| Resend | ‚úÖ Ready | Transacional |
| SendGrid | ‚úÖ Ready | Transacional + Inbound |
| SMTP | üüß Pending | Gen√©rico |
| DNS/SPF/DKIM | ‚úÖ Ready | Configura√ß√£o |

### 6. ERP
| Sistema | Status | Descri√ß√£o |
|---------|--------|-----------|
| Bling | üüß Coming Soon | Sincroniza√ß√£o |
| Tiny | üüß Coming Soon | Sincroniza√ß√£o |

---

## Estrutura de Credenciais

```typescript
// Tabela: integration_credentials
{
  tenant_id: uuid,
  provider: string,      // 'mercadopago', 'meta', etc
  credentials: jsonb,    // Criptografado
  is_enabled: boolean,
  metadata: jsonb,
  created_at: timestamptz,
  updated_at: timestamptz,
}
```

---

## √Årea de Plataforma (Admin)

Dispon√≠vel apenas para `isPlatformOperator`:

| Tab | Descri√ß√£o |
|-----|-----------|
| Resumo | Dashboard de status geral |
| Email e Dom√≠nios | SendGrid + Cloudflare |
| WhatsApp | Z-API manager account |
| Fiscal | Focus NFe |
| Log√≠stica | Loggi OAuth |
| IA | Firecrawl e AI config |
| Late | Late integration |
| Mercado Livre | Meli platform config |

---

## Fluxo OAuth (Marketplaces)

```
1. Usu√°rio clica "Conectar"
2. Redireciona para oauth do provider
3. Provider redireciona de volta com code
4. Edge function troca code por tokens
5. Tokens armazenados (criptografados)
6. Status atualizado para "connected"
```

---

## Webhooks

| Provider | Endpoint | Descri√ß√£o |
|----------|----------|-----------|
| Mercado Pago | `/webhooks/mercadopago` | Pagamentos |
| Meta | `/webhooks/meta` | Cat√°logo |
| Mercado Livre | `/webhooks/meli` | Pedidos |

---

## Componentes Relacionados

| Componente | Descri√ß√£o |
|------------|-----------|
| `DomainAndEmailSettings` | Container unificado para dom√≠nio + email |
| `DomainSettingsContent` | L√≥gica extra√≠da de `Domains.tsx` para reutiliza√ß√£o |
| `AddDomainDialog` | Dialog para adicionar dom√≠nio personalizado |
| `DomainInstructionsDialog` | Instru√ß√µes de configura√ß√£o DNS |

---

## Pend√™ncias

- [ ] Implementar WhatsApp Cloud API
- [ ] Implementar integra√ß√µes ERP (Bling, Tiny)
- [ ] Melhorar UX de reconex√£o OAuth
- [ ] Logs de erro por integra√ß√£o
